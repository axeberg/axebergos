# Architecture Overview

This document provides a visual guide to axeberg's architecture.

## System Layers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Browser Environment                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                              axeberg OS                                │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │                         User Space                                │ │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │ │  │
│  │  │  │    Shell    │  │   Editor    │  │     User Programs       │   │ │  │
│  │  │  │   (sh)      │  │   (ed)      │  │  (cat, grep, ls, ...)   │   │ │  │
│  │  │  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘   │ │  │
│  │  └─────────┼────────────────┼─────────────────────┼─────────────────┘ │  │
│  │            │                │                     │                    │  │
│  │            ▼                ▼                     ▼                    │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │                      System Call Interface                        │ │  │
│  │  │   read() write() open() close() spawn() kill() pipe() ...        │ │  │
│  │  └──────────────────────────────┬───────────────────────────────────┘ │  │
│  │                                 │                                      │  │
│  │                                 ▼                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │                           Kernel                                  │ │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │ │  │
│  │  │  │  Process   │  │   Memory   │  │    VFS     │  │    IPC     │  │ │  │
│  │  │  │  Manager   │  │  Manager   │  │            │  │            │  │ │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │ │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │ │  │
│  │  │  │   Users    │  │  Sessions  │  │  Signals   │  │   Timers   │  │ │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │ │  │
│  │  └──────────────────────────────┬───────────────────────────────────┘ │  │
│  │                                 │                                      │  │
│  │                                 ▼                                      │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │                        Async Executor                             │ │  │
│  │  │            (Priority-based task scheduler)                        │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         Browser APIs                                   │  │
│  │   Console  │  OPFS  │  WebSocket  │  Crypto  │  Fetch  │  xterm.js    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Kernel Components

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 Kernel                                       │
│                                                                              │
│  ┌─────────────────────────┐     ┌─────────────────────────┐                │
│  │     Process Table       │     │      Object Table       │                │
│  │  ┌─────┬─────┬─────┐   │     │  ┌─────┬─────┬─────┐   │                │
│  │  │ PID │State│ FDs │   │     │  │Handle│RefCt│Object│  │                │
│  │  │  1  │ Run │ ... │   │     │  │  0   │  2  │ File │  │                │
│  │  │  2  │Sleep│ ... │   │     │  │  1   │  1  │ Pipe │  │                │
│  │  │  3  │ Run │ ... │   │     │  │  2   │  3  │ TTY  │  │                │
│  │  └─────┴─────┴─────┘   │     │  └─────┴─────┴─────┘   │                │
│  └─────────────────────────┘     └─────────────────────────┘                │
│                                                                              │
│  ┌─────────────────────────┐     ┌─────────────────────────┐                │
│  │     User Database       │     │    Session Manager      │                │
│  │  ┌─────────────────┐   │     │  ┌───────────────────┐  │                │
│  │  │ /etc/passwd     │   │     │  │ Session 1 (root)  │  │                │
│  │  │ /etc/shadow     │   │     │  │   └─ PID 1, 2, 3  │  │                │
│  │  │ /etc/group      │   │     │  │ Session 2 (alice) │  │                │
│  │  └─────────────────┘   │     │  │   └─ PID 4, 5     │  │                │
│  └─────────────────────────┘     └─────────────────────────┘                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        Virtual File System                           │    │
│  │                                                                      │    │
│  │    /                                                                 │    │
│  │    ├── bin/                                                          │    │
│  │    ├── dev/           ← DevFS (null, zero, random, tty)              │    │
│  │    ├── etc/           ← Config files (passwd, shadow, group)         │    │
│  │    ├── home/                                                         │    │
│  │    ├── proc/          ← ProcFS (process info, /proc/[pid]/*)         │    │
│  │    ├── sys/           ← SysFS (kernel info)                          │    │
│  │    └── tmp/                                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │       IPC        │  │     Signals      │  │     Timers       │          │
│  │  • Pipes         │  │  • Pending set   │  │  • Priority heap │          │
│  │  • Message Queues│  │  • Delivery      │  │  • Async wakeup  │          │
│  │  • Shared Memory │  │  • Coalescing    │  │  • Cancellation  │          │
│  │  • Semaphores    │  │  • Handlers      │  │                  │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Pipeline Execution

How `cat file.txt | grep pattern | wc -l` executes:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Shell Parser                                    │
│                                                                              │
│   Input: "cat file.txt | grep pattern | wc -l"                               │
│                              │                                               │
│                              ▼                                               │
│   Pipeline {                                                                 │
│     commands: [                                                              │
│       Command { program: "cat", args: ["file.txt"] },                        │
│       Command { program: "grep", args: ["pattern"] },                        │
│       Command { program: "wc", args: ["-l"] },                               │
│     ],                                                                       │
│     background: false                                                        │
│   }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Pipeline Executor                                 │
│                                                                              │
│  1. Create pipes:                                                            │
│     pipe1 = kernel.pipe()   // cat → grep                                    │
│     pipe2 = kernel.pipe()   // grep → wc                                     │
│                                                                              │
│  2. Spawn processes:                                                         │
│                                                                              │
│     ┌──────────┐    pipe1    ┌──────────┐    pipe2    ┌──────────┐          │
│     │   cat    │────────────▶│   grep   │────────────▶│    wc    │          │
│     │          │             │          │             │          │          │
│     │ stdin:   │             │ stdin:   │             │ stdin:   │          │
│     │  file.txt│             │  pipe1[0]│             │  pipe2[0]│          │
│     │ stdout:  │             │ stdout:  │             │ stdout:  │          │
│     │  pipe1[1]│             │  pipe2[1]│             │  terminal│          │
│     └──────────┘             └──────────┘             └──────────┘          │
│                                                                              │
│  3. Wait for all processes to complete                                       │
│  4. Return exit code of last process (wc)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Process States

```
                          spawn()
                             │
                             ▼
                      ┌─────────────┐
                      │   Created   │
                      └──────┬──────┘
                             │
                             ▼
     ┌───────────────────────────────────────────────┐
     │                                               │
     │              ┌─────────────┐                  │
     │   ┌─────────▶│   Running   │◀─────────┐      │
     │   │          └──────┬──────┘          │      │
     │   │                 │                 │      │
     │   │    I/O block    │    I/O ready    │      │
     │   │                 ▼                 │      │
     │   │          ┌─────────────┐          │      │
     │   └──────────│  Sleeping   │──────────┘      │
     │              └─────────────┘                  │
     │                     │                         │
     │              SIGSTOP│                         │
     │                     ▼                         │
     │              ┌─────────────┐                  │
     │              │   Stopped   │                  │
     │              └──────┬──────┘                  │
     │                     │                         │
     │              SIGCONT│                         │
     │                     │                         │
     └─────────────────────┘                         │
                                                     │
                          exit() or signal           │
                             │                       │
                             ▼                       │
                      ┌─────────────┐                │
                      │   Zombie    │ (waiting for   │
                      └──────┬──────┘  parent wait)  │
                             │                       │
                        wait()                       │
                             │                       │
                             ▼                       │
                      ┌─────────────┐                │
                      │   Reaped    │────────────────┘
                      └─────────────┘
```

## Session & TTY Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               Terminal                                       │
│                             (xterm.js)                                       │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              TTY Driver                                      │
│                                                                              │
│   • Line buffering                                                           │
│   • Echo handling                                                            │
│   • Special keys (Ctrl+C, Ctrl+Z, Ctrl+D)                                    │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Session                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Session ID: 1                                                          │ │
│  │ User: root (uid=0)                                                     │ │
│  │ Controlling TTY: /dev/tty0                                             │ │
│  │                                                                        │ │
│  │ ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ Foreground Process Group                                           │ │ │
│  │ │   ┌─────────┐   ┌─────────┐   ┌─────────┐                          │ │ │
│  │ │   │ shell   │───│  cat    │───│  grep   │  (receives Ctrl+C)       │ │ │
│  │ │   │ PID 1   │   │ PID 2   │   │ PID 3   │                          │ │ │
│  │ │   └─────────┘   └─────────┘   └─────────┘                          │ │ │
│  │ └────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  │ ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ Background Process Groups                                          │ │ │
│  │ │   ┌─────────┐                                                      │ │ │
│  │ │   │ sleep & │  (does not receive Ctrl+C)                           │ │ │
│  │ │   │ PID 4   │                                                      │ │ │
│  │ │   └─────────┘                                                      │ │ │
│  │ └────────────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Memory Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Memory Manager                                     │
│                                                                              │
│  Per-Process Memory Tracking:                                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Process 1 (shell)                                                       ││
│  │   Allocated: 1.2 MB    Peak: 2.1 MB    Limit: 64 MB                     ││
│  │   ├── Heap: 800 KB                                                      ││
│  │   ├── Stack: 256 KB                                                     ││
│  │   └── Buffers: 144 KB                                                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Process 2 (grep)                                                        ││
│  │   Allocated: 512 KB    Peak: 512 KB    Limit: 64 MB                     ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Shared Memory Regions:                                                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ SHM "buffer" (4 KB)                                                     ││
│  │   Attached: [Process 1, Process 3]                                      ││
│  │   Protection: READ | WRITE                                              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow: Reading a File

```
                    User Program
                         │
                         │ read(fd, buf, len)
                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Syscall Dispatcher                                  │
│                                                                              │
│  match syscall {                                                             │
│      SYS_READ => handle_read(fd, buf, len),                                  │
│      ...                                                                     │
│  }                                                                           │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Object Table                                       │
│                                                                              │
│  fd → Handle → Object (File | Pipe | TTY | ...)                              │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
              ┌──────────┐ ┌──────────┐ ┌──────────┐
              │   File   │ │   Pipe   │ │   TTY    │
              │  Object  │ │  Object  │ │  Object  │
              └────┬─────┘ └────┬─────┘ └────┬─────┘
                   │            │            │
                   ▼            ▼            ▼
              ┌──────────┐ ┌──────────┐ ┌──────────┐
              │   VFS    │ │   IPC    │ │ Terminal │
              │ MemoryFs │ │  Buffer  │ │  Driver  │
              └──────────┘ └──────────┘ └──────────┘
```

## Module Dependencies

```
                              ┌────────────────┐
                              │    lib.rs      │
                              │   (entry)      │
                              └───────┬────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
             ┌────────────┐    ┌────────────┐    ┌────────────┐
             │   shell/   │    │   kernel/  │    │    vfs/    │
             │            │    │            │    │            │
             │  parser    │───▶│  syscall   │◀───│  memory    │
             │  executor  │    │  process   │    │  persist   │
             │  builtins  │    │  executor  │    │            │
             │  programs/ │    │  users     │    │            │
             └────────────┘    │  signals   │    └────────────┘
                               │  timers    │
                               │  ipc/      │
                               │  procfs    │
                               │  devfs     │
                               │  sysfs     │
                               └────────────┘
                                      │
                                      ▼
                              ┌────────────────┐
                              │   platform/   │
                              │               │
                              │  Browser APIs │
                              │  (web-sys)    │
                              └────────────────┘
```

## File Descriptors & Inheritance

```
Parent Process (shell)              Child Process (cat)
┌───────────────────────┐           ┌───────────────────────┐
│ FD Table              │  spawn()  │ FD Table (inherited)  │
│ ┌────┬────────────┐   │ ───────▶  │ ┌────┬────────────┐   │
│ │ 0  │ stdin      │   │           │ │ 0  │ stdin      │   │
│ │ 1  │ stdout     │   │           │ │ 1  │ pipe[1]    │ ← redirected
│ │ 2  │ stderr     │   │           │ │ 2  │ stderr     │   │
│ │ 3  │ open file  │   │           │ │ 3  │ (closed)   │ ← not inherited
│ └────┴────────────┘   │           │ └────┴────────────┘   │
└───────────────────────┘           └───────────────────────┘

Note: FDs 0, 1, 2 always exist. Others inherited based on flags.
```

## See Also

- [Kernel Overview](docs/kernel/overview.md) - Detailed kernel documentation
- [Syscall Reference](docs/kernel/syscalls.md) - System call API
- [Shell Guide](docs/userspace/shell.md) - Shell usage and commands
